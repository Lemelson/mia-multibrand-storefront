# ADR: Режимы данных (JSON vs DB) и dual-write

- Дата: 2026-02-13
- Статус: accepted

## Контекст

Проект начинался как локальный MVP с хранением данных в JSON (`src/data/*.json`), потому что это:

- максимально быстрый старт (без инфраструктуры);
- удобно редактировать руками.

Но для production (например, Vercel) есть ограничения:

- файловая система в рантайме read-only;
- JSON-файлы в репозитории не являются "живым" источником данных для админки/заказов.

## Решение

Поддерживаем 2 источника данных:

1. JSON (dev/MVP)
2. Postgres через Prisma (production и любой окружение, где нужна надежность)

Выбор источника:

- `DATA_SOURCE=json|db` (явный выбор)
- если не задано, авто-режим: DB при наличии `DATABASE_URL`, иначе JSON

Production правило:

- если DB настроена, чтение/запись идут через DB независимо от `DATA_SOURCE`

Dual-write:

- флаг `DUAL_WRITE=true` разрешает писать "в оба источника" в dev, чтобы можно было:
  - мигрировать данные из JSON в DB;
  - поддерживать JSON как "слепок" при работе в DB-режиме.

## Альтернативы

- Только JSON:
  - упирается в read-only FS на Vercel и в отсутствие транзакционности/конкурентного доступа.
- Только DB:
  - замедляет старт и усложняет локальную разработку без Postgres.

## Последствия

- Плюсы:
  - быстрый локальный MVP и нормальный production путь;
  - код UI/API не зависит от конкретного хранилища.
- Минусы/риски:
  - нужно следить за консистентностью конвертеров `src/lib/server-data/converters.ts`;
  - dual-write требует дисциплины (понимать, какой источник сейчас "главный").

